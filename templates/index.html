<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MeArm Pro æ§åˆ¶å°</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #222; color: #fff; text-align: center; padding: 10px; user-select: none; }
        
        .header { background: #333; padding: 10px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { margin: 0; font-size: 18px; }
        .btn-home { background: #ff9800; border: none; border-radius: 5px; color: white; padding: 8px 15px; font-weight: bold; }

        /* === æ–°å¢ï¼šç·Šæ€¥æ“ä½œå€ === */
        .emergency-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* æŒ‰éˆ• 1: å–®ç´”åœæ­¢ */
        .btn-stop {
            background-color: #f44336; /* ç´…è‰² */
            color: white;
            border: 2px solid #b71c1c;
            width: 48%;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            box-shadow: 0 4px #b71c1c;
        }
        
        /* æŒ‰éˆ• 2: åœæ­¢ä¸¦é‡ç½® */
        .btn-reset {
            background-color: #ff9800; /* æ©˜è‰² */
            color: white;
            border: 2px solid #e65100;
            width: 48%;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            box-shadow: 0 4px #e65100;
        }

        .btn-stop:active, .btn-reset:active { transform: scale(0.96); opacity: 0.9; }

        .panel { background: #333; border-radius: 15px; padding: 15px; margin-bottom: 20px; }
        button { cursor: pointer; touch-action: manipulation; }

        /* æ‰‹å‹•æ§åˆ¶å€ */
        .d-pad { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; max-width: 260px; margin: 0 auto; }
        .btn-dir { background: #2196F3; border: none; border-radius: 8px; color: white; height: 60px; font-size: 20px; font-weight: bold; }
        .empty { visibility: hidden; }

        .elbow-group, .gripper-group { display: flex; justify-content: space-between; margin-top: 10px; }
        .btn-elbow { width: 48%; background: #9c27b0; border: none; border-radius: 8px; padding: 15px; color: white; font-size: 18px; }
        .btn-grip { width: 48%; padding: 15px; font-size: 18px; font-weight: bold; border: none; border-radius: 8px; }
        .btn-open { background: #00bcd4; color: black; }
        .btn-close { background: #f44336; color: white; }

        /* è‡ªå‹•å€ */
        .auto-controls { display: flex; flex-direction: column; gap: 10px; }
        select { padding: 15px; font-size: 18px; border-radius: 10px; border: none; background: #444; color: white; outline: none; text-align: center; appearance: none; }
        .btn-auto { background: #4CAF50; border: none; padding: 20px; font-size: 22px; border-radius: 10px; color: white; box-shadow: 0 4px #2e7d32; }
        .speed-opt { margin-bottom: 10px; font-size: 14px; }
        input[type=radio] { transform: scale(1.3); margin: 0 5px; }
    </style>
</head>
<body>

    <div class="header">
        <h2>ğŸ® MeArm æ§åˆ¶å°</h2>
        </div>

    <div class="emergency-group">
        <button class="btn-stop" onclick="emergencyStop()">ğŸ›‘ æš«åœ/æ”¾é¬†</button>
        
        <button class="btn-reset" onclick="stopAndReset()">ğŸ”„ åœæ­¢ä¸¦æ­¸ä½</button>
    </div>

    <div class="panel">
        <div class="speed-opt">
            é€Ÿåº¦: 
            <label><input type="radio" name="step" value="20">å¾®(20)</label>
            <label><input type="radio" name="step" value="80" checked>å¿«(80)</label>
        </div>

        <div class="d-pad">
            <div class="empty"></div>
            <button class="btn-dir" onclick="move('shoulder', 1)">â–²</button>
            <div class="empty"></div>
            <button class="btn-dir" onclick="move('base', -1)">â—€</button>
            <button class="btn-dir" onclick="move('shoulder', -1)">â–¼</button>
            <button class="btn-dir" onclick="move('base', 1)">â–¶</button>
        </div>

        <div class="elbow-group">
            <button class="btn-elbow" onclick="move('elbow', 1)">å‰ä¼¸</button>
            <button class="btn-elbow" onclick="move('elbow', -1)">å¾Œæ‹‰</button>
        </div>

        <div class="gripper-group">
            <button class="btn-grip btn-open" onclick="setGripper('open')">ğŸ‘ é–‹</button>
            <button class="btn-grip btn-close" onclick="setGripper('close')">âœŠ å¤¾</button>
        </div>
    </div>

    <div class="panel" style="border: 2px solid #4CAF50;">
        <div class="auto-controls">
            <select id="stackMode">
                <option value="single">ğŸ§± å–®ä¸€å †ç–Š (1é¡†)</option>
                <option value="pyramid">ğŸ—ï¸ å‰å¾Œé‡‘å­—å¡” (3é¡†)</option>
                <option value="side">ğŸ”º æ©«å‘é‡‘å­—å¡” (3é¡†)</option>
                <option value="tower">ğŸ—¼ é›™å±¤å¡” (2é¡†)</option>
                <option value="tower3">ğŸ™ï¸ æ‘©å¤©å¤§æ¨“ (3é¡†)</option>
            </select>
            
            <button class="btn-auto" onclick="runTask()">ğŸš€ åŸ·è¡Œä»»å‹™</button>
        </div>
        <p id="status" style="color:#aaa; font-size:14px; margin-top:10px;"></p>
    </div>

    <script>
        function getStep() { return parseInt(document.querySelector('input[name="step"]:checked').value); }
        function move(axis, dir) { fetch('/move', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ axis: axis, step: getStep() * dir }) }); }
        function setGripper(action) { fetch('/set_gripper', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: action }) }); }
        
        // é‚è¼¯ 1: å–®ç´”å«åœ
        function emergencyStop() {
            let status = document.getElementById("status");
            status.innerText = "ğŸš¨ å¼·åˆ¶åœæ­¢...";
            status.style.color = "red";
            fetch('/stop', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                status.innerText = "â›” å·²æš«åœ (é¦¬é”æ”¾é¬†)";
                if (navigator.vibrate) navigator.vibrate(200);
            });
        }

        // é‚è¼¯ 2: åœæ­¢å¾Œé‡æ–°åš (Stop -> Wait -> Home)
        function stopAndReset() {
            let status = document.getElementById("status");
            status.innerText = "ğŸš¨ åœæ­¢ä¸¦æº–å‚™æ­¸ä½...";
            status.style.color = "#ff9800";
            
            // 1. å…ˆå«åœ
            fetch('/stop', { method: 'POST' })
            .then(() => {
                // 2. ç­‰å¾… 0.5 ç§’ (ç¢ºä¿è¿´åœˆçœŸçš„åœäº†)
                status.innerText = "â³ æ­¸ä½ä¸­...";
                setTimeout(() => {
                    // 3. å‘¼å«æ­¸ä½ (é€™æœƒé‡ç½®åœæ­¢æ——æ¨™)
                    fetch('/home', { method: 'POST' })
                    .then(() => {
                        status.innerText = "âœ… å·²é‡ç½® (æº–å‚™å°±ç·’)";
                        status.style.color = "#4CAF50";
                        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                    });
                }, 500); 
            });
        }

        function runTask() {
            let mode = document.getElementById("stackMode").value;
            let status = document.getElementById("status");
            let endpoint = '/auto_stack';
            let bodyData = {};

            status.innerText = "â³ ä»»å‹™åŸ·è¡Œä¸­...";
            status.style.color = "#aaa";
            
            if (mode === 'single') {
                endpoint = '/auto_stack';
            } else {
                endpoint = '/build_pyramid';
                bodyData = { shape_type: mode };
            }
            
            fetch(endpoint, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(bodyData)
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'completed') {
                    status.innerText = "âœ… ä»»å‹™å®Œæˆ";
                    status.style.color = "#4CAF50";
                } else if (data.status === 'stopped') {
                    status.innerText = "â›” ä»»å‹™å·²ä¸­æ–·";
                    status.style.color = "red";
                } else {
                    status.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤";
                }
            })
            .catch(err => status.innerText = "âŒ é€£ç·šéŒ¯èª¤");
        }
    </script>
</body>
</html>
